<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Seguimiento - GR√öA UARM</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header-card { background: white; border-radius: 20px; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); margin-bottom: 30px; text-align: center; border: 3px solid #4f46e5; position: relative; }
        .logo { width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 40px; }
        .header-card h1 { color: #1e293b; font-size: 2.5em; margin-bottom: 10px; font-weight: 700; }
        .header-card p { color: #64748b; font-size: 1.2em; }
        .reload-btn { position: absolute; top: 30px; right: 30px; padding: 12px 24px; background: #10b981; color: white; border: none; border-radius: 10px; font-size: 1em; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); transition: all 0.3s; }
        .reload-btn:hover { background: #059669; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(16, 185, 129, 0.6); }
        .info-banner { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-left: 5px solid #0ea5e9; padding: 20px; border-radius: 15px; margin-bottom: 30px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .info-banner strong { color: #0369a1; font-size: 1.1em; }
        .selector-card { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 30px; }
        .selector-label { font-size: 1.2em; font-weight: 600; color: #1e293b; margin-bottom: 15px; display: block; }
        select { width: 100%; padding: 18px 24px; font-size: 1.1em; border: 3px solid #e2e8f0; border-radius: 15px; background: white; cursor: pointer; transition: all 0.3s; color: #1e293b; }
        select:hover { border-color: #667eea; box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1); }
        select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); text-align: center; transition: transform 0.3s, box-shadow 0.3s; border-top: 5px solid #667eea; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.25); }
        .stat-card h3 { color: #64748b; font-size: 0.9em; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
        .stat-card .value { color: #1e293b; font-size: 3em; font-weight: 700; line-height: 1; }
        .stat-card .trend { margin-top: 15px; font-size: 1em; font-weight: 600; }
        .trend.up { color: #10b981; }
        .trend.down { color: #ef4444; }
        .trend.neutral { color: #f59e0b; }
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 30px; margin-bottom: 30px; }
        .chart-card { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); transition: transform 0.3s; }
        .chart-card:hover { transform: translateY(-5px); }
        .chart-card h2 { color: #1e293b; margin-bottom: 20px; font-size: 1.4em; text-align: center; font-weight: 600; }
        .chart-wrapper { position: relative; height: 300px; }
        .chart-combined { grid-column: 1 / -1; }
        .chart-combined .chart-wrapper { height: 400px; }
        .loading { text-align: center; padding: 60px; background: white; border-radius: 20px; margin: 20px 0; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .loading-spinner { border: 5px solid #f3f4f6; border-top: 5px solid #667eea; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .no-data { text-align: center; padding: 80px 20px; color: #64748b; font-size: 1.3em; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .error-message { background: #fee2e2; color: #991b1b; padding: 25px; border-radius: 15px; margin-bottom: 20px; border-left: 5px solid #ef4444; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2); }
        .debug-info { background: #fef3c7; border-left: 5px solid #f59e0b; padding: 15px; border-radius: 10px; margin-bottom: 20px; font-size: 0.9em; font-family: monospace; max-height: 200px; overflow-y: auto; }
        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
            .chart-combined { grid-column: 1; }
            .stats-grid { grid-template-columns: 1fr; }
            .reload-btn { position: relative; top: auto; right: auto; margin-top: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-card">
            <button class="reload-btn" onclick="cargarDatos()">üîÑ Recargar Datos</button>
            <div class="logo">üè•</div>
            <h1>Dashboard de Seguimiento - GR√öA</h1>
            <p>Sistema de monitoreo de propulsiones UARM</p>
        </div>
        <div id="loadingIndicator" class="loading">
            <div class="loading-spinner"></div>
            <p style="color: #1e293b; font-size: 1.2em; font-weight: 600;">Cargando datos desde Google Sheets...</p>
        </div>
        <div id="errorContainer" style="display: none;"></div>
        <div id="debugInfo" style="display: none;"></div>
        <div id="infoBox" class="info-banner" style="display: none;">
            <strong>üìä Datos cargados:</strong> <span id="infoText"></span>
        </div>
        <div class="selector-card" id="selectorCard" style="display: none;">
            <label class="selector-label">Seleccionar Residente:</label>
            <select id="residentSelect"><option value="">-- Seleccione un residente --</option></select>
        </div>
        <div class="stats-grid" id="statsContainer" style="display: none;">
            <div class="stat-card"><h3>Total Registros</h3><div class="value" id="totalRegistros">0</div></div>
            <div class="stat-card"><h3>Promedio Propulsiones</h3><div class="value" id="avgPropulsiones">0</div></div>
            <div class="stat-card"><h3>Promedio Tiempo (seg)</h3><div class="value" id="avgTiempo">0</div></div>
            <div class="stat-card"><h3>Tendencia</h3><div class="value trend" id="tendencia">--</div></div>
        </div>
        <div class="charts-grid" id="chartsContainer">
            <div class="no-data">Los datos se cargar√°n autom√°ticamente desde Google Sheets...</div>
        </div>
    </div>
    <script>
        const SHEET_ID = '1J4m__WGpBuzCU1dgpP5ZWWbY5yUakq-V8eDy8iRpUfg';
        const SHEET_NAME = 'DATOS';
        let datosOriginales = [];
        let charts = {};
        
        function cargarDatos() {
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('errorContainer').style.display = 'none';
            document.getElementById('debugInfo').style.display = 'none';
            document.getElementById('selectorCard').style.display = 'none';
            document.getElementById('infoBox').style.display = 'none';
            
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;
            console.log('üîÑ Cargando datos desde:', url);
            
            Papa.parse(url, {
                download: true,
                header: false,
                skipEmptyLines: true,
                complete: function(results) {
                    console.log('‚úÖ Datos recibidos, total filas:', results.data.length);
                    
                    let headerIndex = -1;
                    for (let i = 0; i < results.data.length; i++) {
                        const row = results.data[i];
                        for (let j = 0; j < row.length; j++) {
                            const cell = row[j] ? row[j].toString().trim().toUpperCase() : '';
                            if (cell === 'FECHA' || cell.includes('FECHA')) {
                                headerIndex = i;
                                console.log('‚úÖ Encabezados encontrados en fila:', i);
                                break;
                            }
                        }
                        if (headerIndex !== -1) break;
                    }
                    
                    if (headerIndex === -1) {
                        mostrarError('No se encontr√≥ la fila de encabezados');
                        return;
                    }
                    
                    let headers = results.data[headerIndex];
                    headers = headers.map(h => h ? h.toString().replace('GRUA ', '').trim() : h);
                    
                    const dataRows = results.data.slice(headerIndex + 1).filter(row => {
                        return row.some(cell => cell && cell.toString().trim() !== '');
                    });
                    
                    console.log('Encabezados limpios:', headers);
                    console.log('Total filas de datos:', dataRows.length);
                    console.log('Primera fila de datos:', dataRows[0]);
                    
                    const processedData = dataRows.map(row => {
                        const obj = {};
                        headers.forEach((header, index) => { 
                            obj[header] = row[index]; 
                        });
                        return obj;
                    });
                    procesarDatos(processedData);
                },
                error: function(error) {
                    console.error('‚ùå Error:', error);
                    mostrarError('Error al cargar datos');
                }
            });
        }
        
        function procesarDatos(datos) {
            datosOriginales = [];
            console.log('üìä Procesando', datos.length, 'filas');
            if (datos.length > 0) {
                console.log('Ejemplo de fila:', datos[0]);
                mostrarDebugInfo(Object.keys(datos[0]));
            }
            
            datos.forEach((fila, idx) => {
                const apellido1 = (fila['APELLIDO 1'] || fila['APELLIDO1'] || fila['APELLIDO 1 '] || '').toString().trim();
                const apellido2 = (fila['APELLIDO 2'] || fila['APELLIDO2'] || fila['APELLIDO 2 '] || '').toString().trim();
                const nombre = (fila['NOMBRE'] || '').toString().trim();
                
                console.log(`Fila ${idx}: apellido1="${apellido1}", apellido2="${apellido2}", nombre="${nombre}"`);
                
                if (apellido1 && apellido2 && nombre) {
                    const nombreCompleto = `${nombre} ${apellido1} ${apellido2}`.toLowerCase().trim();
                    const fecha = (fila['FECHA'] || '').toString().trim();
                    const supervisor = (fila['SUPERVISOR'] || '').toString().trim();
                    const propulsiones = parseInt(fila['N¬∫ PROPULSIONES'] || fila['N.¬∫ PROPULSIONES'] || fila['N¬∫ PROPULSIONES '] || 0);
                    const tiempo = parseInt(fila['TIEMPO TOLERADO (seg)'] || fila['TIEMPO TOLERADO'] || fila['TIEMPO TOLERADO (seg) '] || 0);
                    const observaciones = (fila['OBSERVACIONES CLINICAS'] || fila['OBSERVACIONES CL√çNICAS'] || fila['OBSERVACIONES CL√çNICAS '] || '').toString().trim();
                    
                    if (fecha && propulsiones > 0 && tiempo > 0) {
                        datosOriginales.push({ fecha, nombre: nombreCompleto, supervisor, propulsiones, tiempo, observaciones });
                        console.log(`‚úÖ Procesado: ${nombreCompleto}`);
                    } else {
                        console.log(`‚ö†Ô∏è Fila omitida: fecha="${fecha}", prop=${propulsiones}, tiempo=${tiempo}`);
                    }
                } else {
                    console.log(`‚ö†Ô∏è Fila omitida por datos incompletos`);
                }
            });
            
            console.log('‚úÖ Total datos procesados:', datosOriginales.length);
            
            if (datosOriginales.length === 0) {
                mostrarError('No se encontraron datos v√°lidos. Revisa la consola para m√°s detalles.');
                return;
            }
            
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('selectorCard').style.display = 'block';
            document.getElementById('infoBox').style.display = 'block';
            const residentes = [...new Set(datosOriginales.map(d => d.nombre))];
            document.getElementById('infoText').textContent = `${datosOriginales.length} registros | ${residentes.length} residentes`;
            poblarSelectorResidentes();
        }
        
        function mostrarDebugInfo(columnas) {
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.style.display = 'block';
            debugDiv.innerHTML = `<strong>üìã Columnas:</strong><br>${columnas.map(col => `"${col}"`).join(', ')}`;
        }
        
        function poblarSelectorResidentes() {
            const residentes = [...new Set(datosOriginales.map(d => d.nombre))].sort();
            const select = document.getElementById('residentSelect');
            select.innerHTML = '<option value="">-- Seleccione un residente --</option>';
            residentes.forEach(nombre => {
                const option = document.createElement('option');
                option.value = nombre;
                option.textContent = nombre.split(' ').map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(' ');
                select.appendChild(option);
            });
            document.getElementById('chartsContainer').innerHTML = `<div class="no-data">‚úÖ ${datosOriginales.length} registros cargados de ${residentes.length} residentes<br><br>Selecciona un residente</div>`;
        }
        
        function mostrarError(mensaje) {
            document.getElementById('loadingIndicator').style.display = 'none';
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `<div class="error-message">‚ö†Ô∏è ${mensaje}</div>`;
            errorContainer.style.display = 'block';
        }
        
        function formatFecha(fecha) {
            if (!fecha) return '';
            try {
                const partes = fecha.split('/');
                if (partes.length === 3) {
                    const meses = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
                    return `${partes[0]} ${meses[parseInt(partes[1])-1]}`;
                }
                return fecha;
            } catch(e) { return fecha; }
        }
        
        function calcularTendencia(datos) {
            if (datos.length < 2) return 'neutral';
            const ultimo = datos[datos.length-1];
            const primero = datos[0];
            const difP = ultimo.propulsiones - primero.propulsiones;
            const difT = ultimo.tiempo - primero.tiempo;
            if (difP > 0 && difT > 0) return 'up';
            if (difP < 0 || difT < 0) return 'down';
            return 'neutral';
        }
        
        function actualizarEstadisticas(datos) {
            const total = datos.length;
            const avgP = (datos.reduce((s,d) => s + d.propulsiones, 0) / total).toFixed(1);
            const avgT = (datos.reduce((s,d) => s + d.tiempo, 0) / total).toFixed(1);
            const tend = calcularTendencia(datos);
            document.getElementById('totalRegistros').textContent = total;
            document.getElementById('avgPropulsiones').textContent = avgP;
            document.getElementById('avgTiempo').textContent = avgT;
            const tendEl = document.getElementById('tendencia');
            tendEl.className = `value trend ${tend}`;
            tendEl.textContent = tend==='up' ? '‚Üë Mejorando' : tend==='down' ? '‚Üì Requiere atenci√≥n' : '‚Üí Estable';
        }
        
        function destruirGraficas() {
            Object.values(charts).forEach(c => c.destroy());
            charts = {};
        }
        
        function crearGraficas(residente) {
            destruirGraficas();
            const datosR = datosOriginales.filter(d => d.nombre === residente).sort((a,b) => {
                const [dA,mA,yA] = a.fecha.split('/');
                const [dB,mB,yB] = b.fecha.split('/');
                return new Date(yA,mA-1,dA) - new Date(yB,mB-1,dB);
            });
            if (datosR.length === 0) return;
            actualizarEstadisticas(datosR);
            document.getElementById('statsContainer').style.display = 'grid';
            const fechas = datosR.map(d => formatFecha(d.fecha));
            const props = datosR.map(d => d.propulsiones);
            const tiempos = datosR.map(d => d.tiempo);
            const container = document.getElementById('chartsContainer');
            container.innerHTML = `
                <div class="chart-card"><h2>üìà Evoluci√≥n N.¬∫ Propulsiones</h2><div class="chart-wrapper"><canvas id="cp"></canvas></div></div>
                <div class="chart-card"><h2>‚è±Ô∏è Evoluci√≥n Tiempo Tolerado</h2><div class="chart-wrapper"><canvas id="ct"></canvas></div></div>
                <div class="chart-card chart-combined"><h2>üìä Evoluci√≥n Combinada</h2><div class="chart-wrapper"><canvas id="cc"></canvas></div></div>
            `;
            charts.p = new Chart(document.getElementById('cp').getContext('2d'), {
                type: 'line',
                data: { labels: fechas, datasets: [{ label: 'Propulsiones', data: props, borderColor: '#667eea', backgroundColor: 'rgba(102,126,234,0.1)', borderWidth: 3, tension: 0.4, fill: true, pointRadius: 8, pointHoverRadius: 10, pointBackgroundColor: '#667eea', pointBorderColor: '#fff', pointBorderWidth: 3 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'N√∫mero de Propulsiones', font: { size: 14, weight: 'bold' } }, grid: { color: 'rgba(0,0,0,0.05)' } }, x: { grid: { display: false } } } }
            });
            charts.t = new Chart(document.getElementById('ct').getContext('2d'), {
                type: 'line',
                data: { labels: fechas, datasets: [{ label: 'Tiempo (seg)', data: tiempos, borderColor: '#764ba2', backgroundColor: 'rgba(118,75,162,0.1)', borderWidth: 3, tension: 0.4, fill: true, pointRadius: 8, pointHoverRadius: 10, pointBackgroundColor: '#764ba2', pointBorderColor: '#fff', pointBorderWidth: 3 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Segundos', font: { size: 14, weight: 'bold' } }, grid: { color: 'rgba(0,0,0,0.05)' } }, x: { grid: { display: false } } } }
            });
            charts.c = new Chart(document.getElementById('cc').getContext('2d'), {
                type: 'line',
                data: { labels: fechas, datasets: [
                    { label: 'Propulsiones', data: props, borderColor: '#667eea', backgroundColor: 'rgba(102,126,234,0.1)', borderWidth: 3, tension: 0.4, yAxisID: 'y', pointRadius: 8, pointHoverRadius: 10, pointBackgroundColor: '#667eea', pointBorderColor: '#fff', pointBorderWidth: 3 },
                    { label: 'Tiempo (seg)', data: tiempos, borderColor: '#764ba2', backgroundColor: 'rgba(118,75,162,0.1)', borderWidth: 3, tension: 0.4, yAxisID: 'y1', pointRadius: 8, pointHoverRadius: 10, pointBackgroundColor: '#764ba2', pointBorderColor: '#fff', pointBorderWidth: 3 }
                ]},
                options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { display: true, position: 'bottom', labels: { padding: 20, font: { size: 14, weight: 'bold' }, usePointStyle: true, pointStyle: 'circle' } } }, scales: { y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Propulsiones', color: '#667eea', font: { size: 14, weight: 'bold' } }, grid: { color: 'rgba(102,126,234,0.1)' } }, y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Tiempo (seg)', color: '#764ba2', font: { size: 14, weight: 'bold' } }, grid: { drawOnChartArea: false } }, x: { grid: { display: false } } } }
            });
        }
        
        document.getElementById('residentSelect').addEventListener('change', (e) => {
            const res = e.target.value;
            if (res) {
                crearGraficas(res);
            } else {
                destruirGraficas();
                document.getElementById('statsContainer').style.display = 'none';
                document.getElementById('chartsContainer').innerHTML = '<div class="no-data">Seleccione un residente</div>';
            }
        });
        
        cargarDatos();
    </script>
</body>
</html>
